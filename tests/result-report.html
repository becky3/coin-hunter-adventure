<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆ</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { font-size: 1.2em; margin: 10px 0; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        #results { margin-top: 20px; }
        .test-item {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid #dee2e6;
        }
        .test-item.pass { border-left-color: #28a745; background: #f0fff4; }
        .test-item.fail { border-left-color: #dc3545; background: #fff5f5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆ</h1>
        <div id="status" class="status info">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>
        <div id="results"></div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆç”¨Canvasï¼ˆéè¡¨ç¤ºï¼‰ -->
    <canvas id="gameCanvas" width="1024" height="576" style="display: none;"></canvas>

    <!-- ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="../src/config.js"></script>
    <script src="../src/levels.js"></script>
    <script src="../src/music.js"></script>
    <script src="../src/player-graphics.js"></script>
    <script src="../src/svg-renderer.js"></script>
    <script src="../src/svg-player-renderer.js"></script>
    <script src="../src/svg-enemy-renderer.js"></script>
    <script src="../src/svg-item-renderer.js"></script>
    <script src="../src/game.js"></script>

    <script>
        // CORSè­¦å‘Šç„¡åŠ¹åŒ–
        window.DISABLE_CORS_WARNING = true;
        
        // ãƒ†ã‚¹ãƒˆçµæœæ ¼ç´
        const testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            categories: []
        };
        
        // ã‚«ãƒ†ã‚´ãƒªä½œæˆ
        function createCategory(name) {
            const category = {
                name: name,
                tests: [],
                passed: 0,
                failed: 0
            };
            testResults.categories.push(category);
            return category;
        }
        
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        function runTest(category, testName, testFn) {
            testResults.total++;
            try {
                const result = testFn();
                if (result) {
                    category.tests.push({ name: testName, passed: true });
                    category.passed++;
                    testResults.passed++;
                } else {
                    throw new Error('ãƒ†ã‚¹ãƒˆå¤±æ•—');
                }
            } catch (error) {
                category.tests.push({ 
                    name: testName, 
                    passed: false, 
                    error: error.message 
                });
                category.failed++;
                testResults.failed++;
            }
        }
        
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–¢æ•°
        function executeTests() {
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
            const systemCategory = createCategory('ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ');
            
            runTest(systemCategory, 'è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿', () => {
                return typeof CANVAS_WIDTH === 'number' && CANVAS_WIDTH === 1024;
            });
            
            runTest(systemCategory, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š', () => {
                return typeof PLAYER_CONFIG === 'object' && 
                       PLAYER_CONFIG.speed > 0 && 
                       PLAYER_CONFIG.jumpPower > 0;
            });
            
            runTest(systemCategory, 'ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿', () => {
                return typeof levelData === 'object' && 
                       Array.isArray(levelData.platforms) &&
                       levelData.platforms.length > 0;
            });
            
            runTest(systemCategory, 'GameStateåˆæœŸåŒ–', () => {
                const gameState = new GameState();
                return gameState.state === 'start';
            });
            
            runTest(systemCategory, 'PlayeråˆæœŸåŒ–', () => {
                const player = new Player(100, 200);
                return player.x === 100 && player.y === 200;
            });
            
            runTest(systemCategory, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•å‡¦ç†', () => {
                const player = new Player(100, 200);
                player.handleInput({ right: true, left: false, jump: false });
                return player.velX === PLAYER_CONFIG.speed;
            });
            
            runTest(systemCategory, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¸ãƒ£ãƒ³ãƒ—å‡¦ç†', () => {
                const player = new Player(100, 200);
                player.onGround = true;
                player.isJumping = false;
                player.handleInput({ right: false, left: false, jump: true });
                return player.velY < 0;
            });
            
            // SVGãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
            const svgCategory = createCategory('SVGãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ');
            
            runTest(svgCategory, 'SVGPlayerRendererå®šç¾©', () => {
                return typeof SVGPlayerRenderer !== 'undefined';
            });
            
            runTest(svgCategory, 'SVGEnemyRendererå®šç¾©', () => {
                return typeof SVGEnemyRenderer !== 'undefined';
            });
            
            runTest(svgCategory, 'SVGItemRendererå®šç¾©', () => {
                return typeof SVGItemRenderer !== 'undefined';
            });
            
            // ãƒ¬ãƒ™ãƒ«ãƒ†ã‚¹ãƒˆ
            const levelCategory = createCategory('ãƒ¬ãƒ™ãƒ«ãƒ†ã‚¹ãƒˆ');
            
            runTest(levelCategory, 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ•°ç¢ºèª', () => {
                return levelData.platforms.length >= 10;
            });
            
            runTest(levelCategory, 'ã‚´ãƒ¼ãƒ«è¨­å®šç¢ºèª', () => {
                return levelData.flag && levelData.flag.x > 1000;
            });
            
            runTest(levelCategory, 'ãƒ¬ãƒ™ãƒ«æ§‹é€ ç¢ºèª', () => {
                const hasGaps = levelData.platforms.some((p, i) => {
                    if (i === 0) return false;
                    const prev = levelData.platforms[i-1];
                    return (p.x - (prev.x + prev.width)) > 100;
                });
                return hasGaps;
            });
        }
        
        // çµæœè¡¨ç¤º
        function displayResults() {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            
            if (testResults.failed === 0) {
                statusEl.className = 'status success';
                statusEl.textContent = 'ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼';
            } else {
                statusEl.className = 'status error';
                statusEl.textContent = `âš ï¸ ${testResults.failed}ä»¶ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—`;
            }
            
            let html = `<div class="summary">
                <h2>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h2>
                <p><strong>åˆè¨ˆ:</strong> ${testResults.total}ä»¶</p>
                <p><strong>æˆåŠŸ:</strong> ${testResults.passed}ä»¶</p>
                <p><strong>å¤±æ•—:</strong> ${testResults.failed}ä»¶</p>
                <p><strong>æˆåŠŸç‡:</strong> ${((testResults.passed / testResults.total) * 100).toFixed(1)}%</p>
            </div>`;
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ
            testResults.categories.forEach(category => {
                html += `<h3>${category.name} (${category.passed}/${category.tests.length})</h3>`;
                category.tests.forEach(test => {
                    const className = test.passed ? 'pass' : 'fail';
                    const icon = test.passed ? 'âœ“' : 'âœ—';
                    const error = test.error ? ` - ${test.error}` : '';
                    html += `<div class="test-item ${className}">${icon} ${test.name}${error}</div>`;
                });
            });
            
            resultsEl.innerHTML = html;
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
            console.log('ãƒ†ã‚¹ãƒˆå®Œäº†:', testResults);
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            window.FINAL_TEST_RESULTS = testResults;
        }
        
        // å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                try {
                    executeTests();
                    displayResults();
                } catch (error) {
                    document.getElementById('status').className = 'status error';
                    document.getElementById('status').textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
            }, 1000);
        });
    </script>
</body>
</html>