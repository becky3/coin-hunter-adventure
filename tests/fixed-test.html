<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®æ­£ç‰ˆã‚²ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
            color: #1a1a1a;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-results {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .overall-summary {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .overall-summary.test-pass {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
        }
        
        .overall-summary.test-fail {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #dc3545;
        }
        
        .test-category {
            margin-bottom: 25px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        
        .test-category.category-pass h3 {
            background-color: #e7f5e7;
            color: #155724;
        }
        
        .test-category.category-fail h3 {
            background-color: #fde7e9;
            color: #721c24;
        }
        
        .test-category h3 {
            margin: 0;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 1.4em;
        }
        
        .category-summary {
            padding: 12px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.95em;
            color: #6c757d;
        }
        
        .test-details {
            background-color: #fff;
            padding: 10px 20px 15px;
        }
        
        .test-item {
            margin: 8px 0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95em;
        }
        
        .test-pass {
            background-color: #e7f5e7;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .test-fail {
            background-color: #fde7e9;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        #gameCanvas {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>ä¿®æ­£ç‰ˆã‚²ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ</h1>
    
    <div class="test-results" id="testResults">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>ãƒ†ã‚¹ãƒˆã‚’åˆæœŸåŒ–ä¸­...</p>
        </div>
    </div>
    
    <!-- ãƒ†ã‚¹ãƒˆç”¨ã®éš ã—Canvas -->
    <canvas id="gameCanvas" width="1024" height="576"></canvas>
    
    <!-- ãƒ†ã‚¹ãƒˆç’°å¢ƒãƒ•ãƒ©ã‚°è¨­å®š -->
    <script>
        window.DISABLE_CORS_WARNING = true;
        window.TEST_MODE = true;
    </script>
    
    <!-- ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="../src/config.js"></script>
    <script src="../src/levels.js"></script>
    <script src="../src/music.js"></script>
    <script src="../src/player-graphics.js"></script>
    <script src="../src/svg-renderer.js"></script>
    <script src="../src/svg-player-renderer.js"></script>
    <script src="../src/svg-enemy-renderer.js"></script>
    <script src="../src/svg-item-renderer.js"></script>
    <script src="../src/game.js"></script>
    
    <script>
        // ä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
        console.log('=== ä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        
        // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºã‚¯ãƒ©ã‚¹
        class TestResultDisplay {
            constructor() {
                this.results = [];
            }
            
            addResults(testResult, runner) {
                this.results.push({
                    summary: testResult,
                    details: runner.results
                });
            }
            
            displayAll() {
                const container = document.getElementById('testResults');
                let html = '<h2>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ</h2>';
                
                // å…¨ä½“ã‚µãƒãƒªãƒ¼
                const totalPassed = this.results.reduce((sum, r) => sum + r.summary.passed, 0);
                const totalFailed = this.results.reduce((sum, r) => sum + r.summary.failed, 0);
                const totalTests = this.results.reduce((sum, r) => sum + r.summary.total, 0);
                
                const overallSuccess = totalFailed === 0;
                const summaryClass = overallSuccess ? 'test-pass' : 'test-fail';
                const summaryIcon = overallSuccess ? 'ğŸ‰' : 'âš ï¸';
                
                html += `<div class="overall-summary ${summaryClass}">
                    <h3>${summaryIcon} å…¨ä½“çµæœ: ${overallSuccess ? 'å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸ' : 'ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚ã‚Š'}</h3>
                    <p>åˆè¨ˆ: ${totalTests}ä»¶ | æˆåŠŸ: ${totalPassed}ä»¶ | å¤±æ•—: ${totalFailed}ä»¶</p>
                </div>`;
                
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ
                for (const result of this.results) {
                    const categoryClass = result.summary.allPassed ? 'category-pass' : 'category-fail';
                    const categoryIcon = result.summary.allPassed ? 'âœ…' : 'âŒ';
                    
                    html += `<div class="test-category ${categoryClass}">
                        <h3>${categoryIcon} ${result.summary.category}</h3>
                        <div class="category-summary">
                            æˆåŠŸ: ${result.summary.passed} / å¤±æ•—: ${result.summary.failed} / åˆè¨ˆ: ${result.summary.total}
                        </div>`;
                    
                    // è©³ç´°çµæœ
                    html += '<div class="test-details">';
                    for (const detail of result.details) {
                        const className = detail.passed ? 'test-pass' : 'test-fail';
                        const status = detail.passed ? 'âœ“' : 'âœ—';
                        const error = detail.error ? ` - ${detail.error}` : '';
                        
                        html += `<div class="test-item ${className}">${status} ${detail.name}${error}</div>`;
                    }
                    html += '</div></div>';
                }
                
                container.innerHTML = html;
                console.log('ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºå®Œäº†');
            }
        }
        
        // ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚¯ãƒ©ã‚¹
        class TestRunner {
            constructor(category) {
                this.category = category;
                this.tests = [];
                this.results = [];
                this.passed = 0;
                this.failed = 0;
            }
            
            test(name, fn) {
                this.tests.push({ name, fn });
            }
            
            async run() {
                console.log(`\\n=== ${this.category} ===`);
                
                for (const test of this.tests) {
                    try {
                        await test.fn();
                        this.results.push({
                            name: test.name,
                            passed: true,
                            error: null
                        });
                        this.passed++;
                        console.log(`âœ“ ${test.name}`);
                    } catch (error) {
                        this.results.push({
                            name: test.name,
                            passed: false,
                            error: error.message
                        });
                        this.failed++;
                        console.error(`âœ— ${test.name}: ${error.message}`);
                    }
                }
                
                return {
                    category: this.category,
                    passed: this.passed,
                    failed: this.failed,
                    total: this.tests.length,
                    allPassed: this.failed === 0
                };
            }
        }
        
        // ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function assert(condition, message) {
            if (!condition) {
                throw new Error(message || 'ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—');
            }
        }
        
        function assertEquals(actual, expected, message) {
            if (actual !== expected) {
                throw new Error(message || `æœŸå¾…å€¤: ${expected}, å®Ÿéš›: ${actual}`);
            }
        }
        
        // å¾…æ©Ÿæ™‚é–“ã‚’çŸ­ç¸®ã—ãŸåŸºæœ¬ãƒ†ã‚¹ãƒˆ
        const basicTests = new TestRunner('åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ');
        
        basicTests.test('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿', () => {
            assert(typeof CANVAS_WIDTH === 'number', 'CANVAS_WIDTHãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            assert(typeof PLAYER_CONFIG === 'object', 'PLAYER_CONFIGãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            assertEquals(CANVAS_WIDTH, 1024, 'CANVAS_WIDTHãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        });
        
        basicTests.test('ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿', () => {
            assert(typeof levelData === 'object', 'levelDataãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            assert(Array.isArray(levelData.platforms), 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é…åˆ—ãŒã‚ã‚Šã¾ã›ã‚“');
            assert(levelData.platforms.length > 0, 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        });
        
        basicTests.test('ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–', () => {
            assert(typeof GameState !== 'undefined', 'GameStateã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            assert(typeof Player !== 'undefined', 'Playerã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            assert(typeof InputManager !== 'undefined', 'InputManagerã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            
            // å®Ÿéš›ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ãƒ†ã‚¹ãƒˆ
            const gameState = new GameState();
            assertEquals(gameState.state, 'start', 'GameStateåˆæœŸçŠ¶æ…‹ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            
            const player = new Player(100, 200);
            assertEquals(player.x, 100, 'Player Xåº§æ¨™ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            assertEquals(player.y, 200, 'Player Yåº§æ¨™ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        });
        
        basicTests.test('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŸºæœ¬å‹•ä½œ', () => {
            const player = new Player(100, 300);
            
            // å³ç§»å‹•
            player.handleInput({ right: true, left: false, jump: false });
            assertEquals(player.velX, PLAYER_CONFIG.speed, 'å³ç§»å‹•é€Ÿåº¦ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            
            // ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã«å¯¾å¿œï¼‰
            player.onGround = true;
            player.isJumping = false;
            player.handleInput({ right: false, left: false, jump: true });
            assert(player.velY < 0, 'ã‚¸ãƒ£ãƒ³ãƒ—æ™‚ã®å‚ç›´é€Ÿåº¦ãŒè² ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
        });
        
        // é«˜é€Ÿã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runFastTests() {
            console.log('é«˜é€Ÿãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹');
            
            const display = new TestResultDisplay();
            
            try {
                const basicResult = await basicTests.run();
                display.addResults(basicResult, basicTests);
                
                // çµæœã‚’è¡¨ç¤º
                display.displayAll();
                
                console.log('=== ãƒ†ã‚¹ãƒˆå®Œäº† ===');
                
                // ãƒ†ã‚¹ãƒˆå®Œäº†ã®å°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®š
                window.TEST_COMPLETED = true;
                
            } catch (error) {
                console.error('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('testResults').innerHTML = `
                    <div class="overall-summary test-fail">
                        <h3>âš ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ã‚ˆã‚ŠçŸ­ã„é…å»¶ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // å¿…è¦ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
            let attempts = 0;
            const maxAttempts = 20;
            
            function checkAndRun() {
                attempts++;
                
                if (typeof CANVAS_WIDTH !== 'undefined' && 
                    typeof levelData !== 'undefined' && 
                    typeof GameState !== 'undefined') {
                    // å…¨ã¦èª­ã¿è¾¼ã¾ã‚ŒãŸå ´åˆ
                    console.log('å¿…è¦ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿å®Œäº†ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ');
                    setTimeout(runFastTests, 100);
                } else if (attempts < maxAttempts) {
                    // ã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯å†è©¦è¡Œ
                    console.log(`èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­... (${attempts}/${maxAttempts})`);
                    setTimeout(checkAndRun, 200);
                } else {
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                    console.error('èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ã‚¨ãƒ©ãƒ¼è¡¨ç¤º');
                    document.getElementById('testResults').innerHTML = `
                        <div class="overall-summary test-fail">
                            <h3>âš ï¸ èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</h3>
                            <p>å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                            <p>CANVAS_WIDTH: ${typeof CANVAS_WIDTH}</p>
                            <p>levelData: ${typeof levelData}</p>
                            <p>GameState: ${typeof GameState}</p>
                        </div>
                    `;
                }
            }
            
            checkAndRun();
        });
    </script>
</body>
</html>