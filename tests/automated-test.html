<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•ã‚²ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ - Coin Hunter Adventure</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4fc3f7;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-controls {
            background: #2d2d2d;
            border: 1px solid #3e3e3e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        button {
            background: #4fc3f7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background: #29b6f6;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .test-output {
            background: #1e1e1e;
            border: 1px solid #3e3e3e;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .test-summary {
            background: #2d2d2d;
            border: 1px solid #3e3e3e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
        
        .game-canvas {
            display: none;
            margin: 20px auto;
            border: 2px solid #4fc3f7;
            border-radius: 8px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running { background: #ff9800; }
        .status-success { background: #4caf50; }
        .status-failed { background: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª è‡ªå‹•ã‚²ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <div class="test-controls">
            <h2>ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
            <button id="runAllTests">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button id="runStateTests">çŠ¶æ…‹ç®¡ç†ãƒ†ã‚¹ãƒˆã®ã¿</button>
            <button id="runMovementTests">å‹•ä½œãƒ†ã‚¹ãƒˆã®ã¿</button>
            <button id="clearOutput">å‡ºåŠ›ã‚¯ãƒªã‚¢</button>
            <button id="exportResults">çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            
            <div style="margin-top: 20px;">
                <label>
                    <input type="checkbox" id="showGameCanvas"> 
                    ã‚²ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                </label>
            </div>
        </div>
        
        <canvas id="gameCanvas" class="game-canvas" width="800" height="400"></canvas>
        
        <div class="test-output" id="testOutput">
            ãƒ†ã‚¹ãƒˆå‡ºåŠ›ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
        </div>
        
        <div class="test-summary" id="testSummary">
            <h2>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h2>
            <div id="summaryContent"></div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <script src="../src/config.js"></script>
    <script src="../src/levels.js"></script>
    <script src="../src/svg-renderer.js"></script>
    <script src="../src/svg-player-renderer.js"></script>
    <script src="../src/svg-enemy-renderer.js"></script>
    <script src="../src/svg-item-renderer.js"></script>
    <script src="../src/player-graphics.js"></script>
    <script src="../src/music.js"></script>
    <script src="../src/game.js"></script>
    
    <!-- ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ -->
    <script src="../src/game-state-manager.js"></script>
    <script src="../src/automated-test-player.js"></script>
    <script src="./automated-game-tests.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let testRunner = null;
        let gameInstance = null;
        let outputElement = document.getElementById('testOutput');
        let summaryElement = document.getElementById('testSummary');
        let isRunning = false;

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        const originalLog = console.log;
        const originalError = console.error;
        
        function captureConsole() {
            console.log = function(...args) {
                originalLog.apply(console, args);
                appendOutput(args.join(' '), 'info');
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                appendOutput(args.join(' '), 'error');
            };
        }
        
        function restoreConsole() {
            console.log = originalLog;
            console.error = originalError;
        }

        // å‡ºåŠ›è¿½åŠ 
        function appendOutput(text, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${text}\n`;
            
            if (type === 'error') {
                outputElement.innerHTML += `<span class="error">${line}</span>`;
            } else if (type === 'success') {
                outputElement.innerHTML += `<span class="success">${line}</span>`;
            } else {
                outputElement.innerHTML += line;
            }
            
            outputElement.scrollTop = outputElement.scrollHeight;
        }

        // ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–
        async function initializeGame() {
            const canvas = document.getElementById('gameCanvas');
            const showCanvas = document.getElementById('showGameCanvas').checked;
            
            if (showCanvas) {
                canvas.style.display = 'block';
            } else {
                canvas.style.display = 'none';
            }

            // ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯å†åˆ©ç”¨
            if (!gameInstance) {
                // ç°¡æ˜“çš„ãªã‚²ãƒ¼ãƒ ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆ
                gameInstance = {
                    canvas: canvas,
                    ctx: canvas.getContext('2d'),
                    player: {
                        x: 50,
                        y: 350,
                        vx: 0,
                        vy: 0,
                        grounded: true,
                        lives: 3,
                        facingRight: true,
                        animation: 'idle'
                    },
                    coins: 0,
                    enemies: [],
                    levelCoins: [
                        { x: 200, y: 300, collected: false },
                        { x: 400, y: 250, collected: false },
                        { x: 600, y: 300, collected: false }
                    ],
                    springs: [],
                    keys: {
                        left: false,
                        right: false,
                        up: false
                    },
                    state: 'playing',
                    currentLevel: 1,
                    frameCount: 0,
                    levelWidth: 3000,
                    cameraX: 0,
                    cameraY: 0,
                    
                    // ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ¢ãƒƒã‚¯
                    update: function() {
                        // ç°¡æ˜“çš„ãªç‰©ç†æ›´æ–°
                        if (this.keys.right) this.player.vx = Math.min(this.player.vx + 0.5, 5);
                        else if (this.keys.left) this.player.vx = Math.max(this.player.vx - 0.5, -5);
                        else this.player.vx *= 0.8;
                        
                        if (this.keys.up && this.player.grounded) {
                            this.player.vy = -10;
                            this.player.grounded = false;
                        }
                        
                        if (!this.player.grounded) {
                            this.player.vy += 0.5;
                        }
                        
                        this.player.x += this.player.vx;
                        this.player.y += this.player.vy;
                        
                        // åœ°é¢ã¨ã®è¡çª
                        if (this.player.y > 350) {
                            this.player.y = 350;
                            this.player.vy = 0;
                            this.player.grounded = true;
                        }
                        
                        this.frameCount++;
                    },
                    
                    draw: function() {
                        // æç”»å‡¦ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
                    }
                };
            }
            
            window.game = gameInstance;
            return gameInstance;
        }

        // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runAllTests() {
            if (isRunning) return;
            
            isRunning = true;
            outputElement.innerHTML = '';
            summaryElement.style.display = 'none';
            
            appendOutput('ğŸš€ è‡ªå‹•ã‚²ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...', 'info');
            
            captureConsole();
            
            try {
                await initializeGame();
                
                testRunner = new AutomatedGameTests();
                testRunner.game = gameInstance;
                
                const results = await testRunner.runAllTests();
                
                displaySummary(results);
                
            } catch (error) {
                appendOutput(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                restoreConsole();
                isRunning = false;
            }
        }

        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        function displaySummary(results) {
            const summaryContent = document.getElementById('summaryContent');
            const { summary, details } = results;
            
            let html = `
                <div>
                    <span class="status-indicator ${summary.failed > 0 ? 'status-failed' : 'status-success'}"></span>
                    <strong>ãƒ†ã‚¹ãƒˆçµæœ:</strong> ${summary.passed}/${summary.total} æˆåŠŸ
                </div>
                <div>æˆåŠŸç‡: ${summary.successRate}</div>
                <div>å®Ÿè¡Œæ™‚é–“: ${summary.duration}</div>
                <hr>
                <h3>è©³ç´°çµæœ:</h3>
            `;
            
            details.forEach(test => {
                const icon = test.passed ? 'âœ…' : 'âŒ';
                const className = test.passed ? 'success' : 'error';
                html += `<div class="${className}">${icon} ${test.name} (${test.duration}ms)</div>`;
                if (test.error) {
                    html += `<div style="margin-left: 20px; color: #ff9800;">â†’ ${test.error}</div>`;
                }
            });
            
            summaryContent.innerHTML = html;
            summaryElement.style.display = 'block';
        }

        // çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportResults() {
            if (!testRunner || !testRunner.testResults.length) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ†ã‚¹ãƒˆçµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const results = {
                summary: testRunner.generateReport().summary,
                details: testRunner.testResults,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `automated-test-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            appendOutput('ğŸ’¾ ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.getElementById('runAllTests').addEventListener('click', runAllTests);
        document.getElementById('clearOutput').addEventListener('click', () => {
            outputElement.innerHTML = '';
            summaryElement.style.display = 'none';
        });
        document.getElementById('exportResults').addEventListener('click', exportResults);
        
        document.getElementById('showGameCanvas').addEventListener('change', (e) => {
            const canvas = document.getElementById('gameCanvas');
            canvas.style.display = e.target.checked ? 'block' : 'none';
        });

        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        appendOutput('âœ¨ è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
        appendOutput('ã€Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
    </script>
</body>
</html>