# CLAUDE.md - プロジェクト開発ルール

## 会話開始時の必須操作

### HTTPサーバー起動
このプロジェクトはSVGファイルを外部読み込みするため、CORS制限により`file://`プロトコルでは正常に動作しません。

**会話開始時に必ずHTTPサーバーを起動してください：**

```bash
python3 -m http.server 8080
```

**アクセスURL:**
- メインゲーム: http://localhost:8080/
- テストページ: http://localhost:8080/tests/test.html

## プロジェクト構造

```
/
├── index.html              # メインゲームファイル
├── style.css               # ゲームスタイル
├── src/                    # メインソースファイル
│   ├── game.js                 # メインゲームロジック
│   ├── config.js               # ゲーム設定
│   ├── levels.js               # レベルデータ
│   ├── music.js                # 音楽システム
│   ├── player-graphics.js      # プレイヤーグラフィック
│   ├── svg-player-renderer.js  # プレイヤーSVGレンダラー
│   ├── svg-enemy-renderer.js   # 敵SVGレンダラー
│   ├── svg-item-renderer.js    # アイテムSVGレンダラー
│   └── svg-renderer.js         # 共通SVGレンダラー
├── assets/                 # ゲームアセット
│   ├── player-*.svg            # プレイヤーアニメーション
│   ├── slime.svg, bird.svg     # 敵キャラクター
│   └── coin.svg, flag.svg, spring.svg  # アイテム類
├── tests/                  # テストファイル
│   ├── test.html               # メインテストページ
│   └── [その他テストファイル]
└── docs/                   # ドキュメント
```

## 必須開発ワークフロー

### Issue作業開始前
1. **必ずIssueにコメントしてから作業開始**
   - GitHub APIでコメント: 作業開始の宣言と実装方針のみ簡潔に記載
   - 詳細なやり取りはPRで行う

### 開発中  
2. **細かくコミットしながら作業**
   - 破壊的変更は特に細かく
   - 各ステップでテスト実行

### PR作成前
3. **必ずテストを実行して成功確認**
   - HTTPサーバーでの動作確認
   - 全機能が正常に動作することを確認

### 作業完了時（必須）
4. **PRを作成してIssueをクローズ**
   - ブランチをpushしてPRを作成
   - PR本文に "Closes #<issue-number>" を含める
   - 詳細な実装内容や問題解決の報告はPRで行う

### 作業終了時
5. **HTTPサーバーを停止**
   - 作業終了を指示された場合はHTTPサーバーを停止
   - `pkill -f "python3 -m http.server"` でプロセス終了

## 開発時の注意事項

1. **HTTPサーバー必須**: SVGファイル読み込みのため、必ずHTTPサーバー経由でアクセス
2. **パス参照**: ファイル移動時は相対パスの更新を忘れずに
3. **テスト実行必須**: 機能変更後は必ずHTTPサーバー経由でテストページでの動作確認とブラウザでの実際のプレイを行う
4. **コミット**: 破壊的変更は細かくコミットして履歴を残す
5. **PR作成**: 作業完了時は必ずPRを作成してIssueにリンク
6. **コメントの簡潔性**: コード内のコメントは簡潔に記述し、変更履歴や前提条件の詳細な説明は避ける

## ブラウザキャッシュ対策（重要）

### 問題
開発中にJavaScriptファイルを変更しても、ブラウザキャッシュにより古いファイルが実行され、テストが期待通りに動作しない問題が頻発する。

### 自動対策（実装済み）
- **localhost環境**: 自動キャッシュバスティングシステムが有効
  - `index.html`と`tests/test.html`でタイムスタンプ付きURL自動生成
  - 開発中は常に最新ファイルが読み込まれる（例: `game.js?v=1749983454184`）
- **本番環境**: 通常のキャッシュ動作でパフォーマンス維持

### 手動対策
キャッシュ問題が発生した場合：
1. **強制リロード**: Ctrl+F5 (Windows) / Cmd+Shift+R (Mac)
2. **開発者ツール**: ネットワークタブで「Disable cache」にチェック
3. **ハードリフレッシュ**: ブラウザの設定から閲覧履歴を削除

### 開発ルール
- ファイル変更後はコンソールでキャッシュバスティング版の確認
- テスト失敗時は最初にキャッシュクリアを試行
- 重要な変更時は複数ブラウザで動作確認
- 設定値テストは固定値ではなく範囲や条件でテスト設計

## テストコマンド

### 現在の状況（更新済み）
**tests/test.htmlは正常に動作しており、全20件のテストが成功しています。**

以下のツールでテスト状況を確認可能：

1. **ブラウザテスト（推奨）**:
   - http://localhost:8080/tests/test.html で全テスト成功
   - 20件中20件成功を確認済み

2. **JSOMテスト（参考）**:
   ```bash
   node scripts/jsdom-test.js
   ```
   - 20件中19件成功（ブラウザ機能制限により1件のみ失敗）
   - 実際のゲーム動作に問題なし

### テスト実行ルール
1. **ブラウザでの確認**: 実装完了後は必ずhttp://localhost:8080/tests/test.html でテスト確認
2. **結果の記録**: ブラウザで確認した結果を記録
   ```bash
   node scripts/manual-verification.js record
   ```
3. **結果の照合**: Claudeも同じ結果を確認
   ```bash
   node scripts/manual-verification.js verify
   ```
4. **コミット基準**: 全20件テスト成功確認後にコミット・PR作成

### 正確な意思疎通システム
- `.test-results.json`ファイルでテスト結果を共有
- ユーザーとClaudeが同じテスト結果データを参照
- ブラウザ確認結果を基準とした正確な状況把握