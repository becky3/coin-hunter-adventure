# CLAUDE.md - プロジェクト開発ルール

## 会話開始時の必須操作

### HTTPサーバー起動
このプロジェクトはSVGファイルを外部読み込みするため、CORS制限により`file://`プロトコルでは正常に動作しません。

**会話開始時に必ずHTTPサーバーを起動してください：**

```bash
python3 -m http.server 8080
```

**アクセスURL:**
- メインゲーム: http://localhost:8080/
- テストページ: http://localhost:8080/tests/test.html

## プロジェクト構造

```
/
├── index.html              # メインゲームファイル
├── style.css               # ゲームスタイル
├── src/                    # メインソースファイル
│   ├── game.js                 # メインゲームロジック
│   ├── config.js               # ゲーム設定
│   ├── levels.js               # レベルデータ
│   ├── music.js                # 音楽システム
│   ├── player-graphics.js      # プレイヤーグラフィック
│   ├── svg-player-renderer.js  # プレイヤーSVGレンダラー
│   ├── svg-enemy-renderer.js   # 敵SVGレンダラー
│   ├── svg-item-renderer.js    # アイテムSVGレンダラー
│   ├── svg-renderer.js         # 共通SVGレンダラー
│   ├── svg-graphics.js         # SVGグラフィックシステム
│   ├── game-state.js           # ゲーム状態管理
│   ├── score-animation.js      # スコアアニメーション
│   ├── player.js               # プレイヤークラス
│   └── input-manager.js        # 入力管理
├── assets/                 # ゲームアセット
│   ├── player-*.svg            # プレイヤーアニメーション
│   ├── slime.svg, bird.svg     # 敵キャラクター
│   └── coin.svg, flag.svg, spring.svg  # アイテム類
├── tests/                  # テストファイル
│   ├── test.html               # メインテストページ
│   └── [その他テストファイル]
└── docs/                   # ドキュメント
```

## 必須開発ワークフロー

### Issue作業開始前
1. **必ずIssueにコメントしてから作業開始**
   - GitHub APIでコメント: 作業開始の宣言と実装方針のみ簡潔に記載
   - 詳細なやり取りはPRで行う

### 開発中  
2. **細かくコミットしながら作業**
   - 破壊的変更は特に細かく
   - 各ステップでテスト実行

### PR作成前
3. **必ずテストを実行して成功確認**
   - HTTPサーバーでの動作確認
   - 全機能が正常に動作することを確認

### 作業完了時（必須）
4. **PRを作成してIssueをクローズ**
   - ブランチをpushしてPRを作成
   - PR本文に "Closes #<issue-number>" を含める
   - 詳細な実装内容や問題解決の報告はPRで行う
   - **重要**: PR作成はClaudeが`gh pr create`コマンドで実行すること
   - ghコマンドが使えない場合は、適切なツールをインストールまたは代替手段を使用

### 作業終了時
5. **HTTPサーバーを停止**
   - 作業終了を指示された場合はHTTPサーバーを停止
   - `pkill -f "python3 -m http.server"` でプロセス終了

## 開発時の注意事項

1. **HTTPサーバー必須**: SVGファイル読み込みのため、必ずHTTPサーバー経由でアクセス
2. **パス参照**: ファイル移動時は相対パスの更新を忘れずに
3. **テスト実行必須**: 機能変更後は必ずHTTPサーバー経由でテストページでの動作確認とブラウザでの実際のプレイを行う
4. **コミット**: 破壊的変更は細かくコミットして履歴を残す
5. **PR作成**: 作業完了時は必ずPRを作成してIssueにリンク
6. **コメントの簡潔性**: コード内のコメントは簡潔に記述し、変更履歴や前提条件の詳細な説明は避ける
7. **エラーハンドリング方針**: 不要なフォールバック機能は実装しない。依存関係が満たされない場合は明確にエラーで終了させ、進行不能な状態やレガシーモードは避ける

## ブラウザキャッシュ対策（重要）

### 問題
開発中にJavaScriptファイルを変更しても、ブラウザキャッシュにより古いファイルが実行され、テストが期待通りに動作しない問題が頻発する。

### 自動対策（実装済み）
- **localhost環境**: 自動キャッシュバスティングシステムが有効
  - `index.html`と`tests/test.html`でタイムスタンプ付きURL自動生成
  - 開発中は常に最新ファイルが読み込まれる（例: `game.js?v=1749983454184`）
- **本番環境**: 通常のキャッシュ動作でパフォーマンス維持

### 手動対策
キャッシュ問題が発生した場合：
1. **強制リロード**: Ctrl+F5 (Windows) / Cmd+Shift+R (Mac)
2. **開発者ツール**: ネットワークタブで「Disable cache」にチェック
3. **ハードリフレッシュ**: ブラウザの設定から閲覧履歴を削除

### 開発ルール
- ファイル変更後はコンソールでキャッシュバスティング版の確認
- テスト失敗時は最初にキャッシュクリアを試行
- 重要な変更時は複数ブラウザで動作確認
- 設定値テストは固定値ではなく範囲や条件でテスト設計

## テスト手順と検証システム

### Claudeによる自動前提条件確認
実際のブラウザテストの前に、以下のツールで前提条件を自動確認：

1. **構造検証ツール**（必須実行）:
   ```bash
   node scripts/curl-test-validator.js
   ```
   - HTTPサーバー動作確認
   - 必要ファイル存在確認
   - スクリプト読み込み設定確認
   - JSON設定ファイル有効性確認

2. **包括的検証ツール**（推奨実行）:
   ```bash
   node scripts/comprehensive-test-results.js
   ```
   - 全検証ツールを統合実行
   - JavaScript基本動作確認（VM環境制限内）
   - テスト準備状況の総合判定

### テストツール一覧

1. **ブラウザテスト（推奨）**:
   - http://localhost:8080/tests/test.html で全テスト成功
   - 20件中20件成功を確認済み

2. **自動ゲームテスト（新機能）**:
   ```bash
   # Node.js環境での実行
   node scripts/run-automated-tests.js
   
   # ブラウザでの実行
   open http://localhost:8080/tests/automated-test.html
   ```
   - ゲーム状態の自動検証（12項目）
   - Claudeが自律的に実行・検証可能
   - 詳細なレポート生成機能付き

3. **JSOMテスト（参考）**:
   ```bash
   node scripts/jsdom-test.js
   ```
   - 20件中19件成功（ブラウザ機能制限により1件のみ失敗）
   - 実際のゲーム動作に問題なし

### ユーザーによる実際のブラウザテスト（必須）

**Claude側での前提条件確認完了後、ユーザーが実行：**

1. **ブラウザでテスト実行**:
   - http://localhost:8080/tests/test.html をブラウザで開く
   - 5-10秒待機してJavaScript実行完了を確認

2. **結果確認項目**:
   - ✅ 「window.gameが存在しません」エラーが表示されない
   - ✅ テスト結果セクションに成功/失敗数が表示される
   - ✅ ブラウザ開発者ツール（F12）でJavaScriptエラーがない
   - 📊 成功したテスト数と失敗したテスト数を記録

3. **トラブルシューティング**:
   - キャッシュ問題: Ctrl+F5（強制リロード）
   - CORS問題: HTTPサーバー動作確認
   - JavaScript無効: ブラウザ設定確認

### テスト実行ルール（厳格）

1. **前提条件確認**:
   - Claudeは必ず `curl-test-validator.js` を実行して前提条件を確認
   - 構造的問題がある場合は修正してから次のステップへ

2. **確認差異問題の根本対策**:
   - **絶対禁止**: Claudeによる推測に基づくテスト結果の記録
   - **必須**: ユーザーによる実際のブラウザ確認完了まで結果記録禁止
   - **透明性**: Claudeは「確認できない」状況を明確に報告

3. **結果記録プロセス**:
   - ユーザーがブラウザ確認結果を報告
   - `.test-results.json` にユーザー報告内容を正確に記録
   - Claudeとユーザーで同じデータを共有

4. **コミット・PR基準**:
   - ユーザーによる実際のテスト確認完了後のみコミット可能
   - 期待される結果とユーザー報告に差異がある場合は原因調査必須

### 検証ツール一覧

- `scripts/curl-test-validator.js` - HTTP基本構造検証（メイン）
- `scripts/comprehensive-test-results.js` - 包括的検証（アクセス可能性とHTTP確認を統合）
- `scripts/jsdom-test.js` - JavaScript基本動作確認
- `scripts/run-automated-tests.js` - 自動ゲームテスト実行

### 技術的制限の明確化

**Claude側の制限**:
- Canvas操作を含むGameクラスのフル実行は不可能（VM環境制限）
- ブラウザ特有の機能（DOM操作、イベント処理）の完全シミュレーション不可能
- → 実際のブラウザテストが技術的に必須

**自動確認可能範囲**:
- ✅ ファイル存在・アクセス可能性
- ✅ スクリプト読み込み設定
- ✅ JSON設定ファイル形式
- ✅ 基本的なJavaScriptクラス定義読み込み

## 開発効率化ルール

### Claude側での確認義務
**Claudeは以下を必ず自動実行してから回答すること：**

1. **コード解析**: 
   - 関連ファイルの読み込みと構文確認
   - 依存関係とインポート順序の検証
   - 非同期処理の流れの確認

2. **自動テスト実行**:
   - 利用可能な検証ツールの実行
   - エラーメッセージの収集と分析
   - 基本的な構造チェック

3. **問題の特定と修正提案**:
   - 検出された問題の根本原因分析
   - 具体的な修正案の提示
   - 修正後の動作予測

**禁止事項**:
- ユーザーに確認作業を丸投げすること
- デバッグページの作成をユーザーに強要すること
- 推測に基づく「確認してください」の多用

### ユーザー確認が必要な場合のみ
- Claude側の自動確認で解決できない場合
- ブラウザ固有の動作確認が必要な場合
- ユーザー側の環境設定に依存する問題