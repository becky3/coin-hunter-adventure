# CLAUDE.md - コインハンターアドベンチャー開発ルール

このファイルは、Claudeがこのプロジェクトで作業する際の必須ルールを定義しています。

## 📚 関連ドキュメント（必読）

作業開始前に以下のドキュメントを必ず確認してください：

- **README.md** - プロジェクト概要とセットアップ手順
- **docs/PROJECT_STRUCTURE.md** - プロジェクト構造の詳細
- **docs/DEVELOPMENT_GUIDE.md** - 開発ガイドとテスト手順
- **docs/TECHNICAL_SPECS.md** - 技術仕様と制限事項

## 🚀 会話開始時の必須操作

1. **HTTPサーバーを起動**（CORS制限回避のため必須）
   ```bash
   # バックグラウンドで起動（推奨）
   nohup python3 -m http.server 8080 > server.log 2>&1 &
   
   # サーバーの動作確認
   curl -I http://localhost:8080/
   ```
   
   **トラブルシューティング:**
   - サーバーが応答しない場合: `pkill -f "python3 -m http.server" && nohup python3 -m http.server 8080 > server.log 2>&1 &`
   - ポートが使用中の場合: 別のポートを使用

2. **開発ドキュメントを確認**
   - 上記の関連ドキュメントを読み込む
   - 現在のIssueとPRの状態を確認

## 💻 必須開発ワークフロー

### 0. 作業着手前の確認（重要）
作業を開始する前に、以下を必ず確認：

#### 指示内容の理解度チェック
- [ ] 期待される成果物が明確か
- [ ] 作業範囲が明確か
- [ ] 技術的な制約や要件が明確か

#### 不明点がある場合の対応
指示が不明確または情報が不足している場合は、**作業開始前に必ず質問**：
- 「〇〇の部分について、△△という理解で正しいでしょうか？」
- 「××を実現するために、以下の情報が必要です：...」
- 「作業範囲は◎◎まででよろしいでしょうか？」

### 1. Issue作業開始前
- **必ずIssueにコメント**: 作業開始の宣言と実装方針を簡潔に記載
- 詳細なやり取りはPRで行う

### 2. 開発中
- **細かくコミット**: 特に破壊的変更は段階的に
- **各ステップでテスト実行**: 自動テストツールを活用

### 3. PR作成前
- **テスト実行必須**: HTTPサーバー経由での動作確認
- **全機能の動作確認**: ゲームプレイが可能であることを確認

### 4. 作業完了時
- **PRを作成**: `gh pr create`コマンドで作成
- **PR本文に記載**: "Closes #<issue-number>"を含める
- **実装内容の報告**: 詳細な変更内容をPRに記載

### 5. 作業終了時
- **HTTPサーバーを停止**: `pkill -f "python3 -m http.server"`
- **プロセスの確認**: `ps aux | grep "python3 -m http.server" | grep -v grep`

## 🎯 開発時の重要ルール

### コーディング規約
1. **コメントの簡潔性**: 変更履歴や前提条件の詳細な説明は避ける
2. **エラーハンドリング**: 不要なフォールバックは実装しない
3. **依存関係**: 満たされない場合は明確にエラーで終了
4. **デバッグコード**: console.logは本番コードに残さない

### テスト実行ルール
1. **統合テストランナー**: `unified-test-runner.js`を必ず実行
2. **自動テスト**: 利用可能な検証ツールをすべて実行
3. **結果の記録**: ユーザー確認完了後のみ記録

### バグ修正時のテスト追加ルール（重要）
1. **バグ修正時は可能な限りテストを追加**
   - バグを再現するテストを先に書く
   - バグを修正してテストが通ることを確認
   - 同じバグの再発を防ぐ

2. **テスト追加の手順**
   ```javascript
   // 1. バグを再現するテストを作成
   test('具体的なバグの症状', () => {
       // バグが発生する条件を再現
       // 期待される正しい動作を検証
   });
   
   // 2. バグを修正
   // 3. テストが通ることを確認
   ```

3. **テスト追加が難しい場合**
   - 最低限、バグの発生条件と修正内容をコメントで記録
   - 将来的にテスト可能な構造へのリファクタリングを検討
   - テストを追加できなかった理由を PR に記載

4. **カバレッジの確認**
   - バグ修正後、`node scripts/coverage-analyzer.js`でカバレッジを確認
   - バグが頻発する箇所は優先的にテストを充実させる

### コミットルール
1. **意味のある単位**: 機能追加、バグ修正、リファクタリングを分離
2. **コミットメッセージ**: 日本語で明確に記載
3. **破壊的変更**: 必ず段階的にコミット

## 🛠️ Claude側での確認義務

### 自動実行必須項目
1. **コード解析**
   - 関連ファイルの構文確認
   - 依存関係の検証
   - 非同期処理の流れ確認

2. **自動テスト実行**
   - 検証ツールの実行
   - エラーメッセージの分析
   - 構造チェック

3. **問題の特定と修正**
   - 根本原因の分析
   - 具体的な修正案の提示
   - 修正後の動作予測

### 禁止事項
- ユーザーに確認作業を丸投げ
- デバッグページの作成を強要
- 推測に基づく「確認してください」の多用

## 📋 チェックリスト

作業開始前：
- [ ] 指示内容を理解し、不明点を解消した
- [ ] HTTPサーバーが起動している
- [ ] 関連ドキュメントを確認した
- [ ] 現在のIssue/PRを確認した

作業中：
- [ ] テストを実行している
- [ ] コミットを適切に分割している
- [ ] エラーハンドリングが適切

作業完了時：
- [ ] すべてのテストが成功
- [ ] PRを作成した
- [ ] ドキュメントを更新した（必要な場合）
- [ ] 引き継ぎ資料を作成した（重要な変更の場合）

## 📝 引き継ぎ資料の管理

### 作成ルール（重要）
- **作成・更新はユーザーから明示的に依頼された時のみ**
- **1回の作業で複数の引き継ぎファイルを作成しない**
- **作業中でも必要に応じて更新可能（ユーザーの指示がある場合）**
- **引き継ぎ資料の作成・更新はmainブランチで直接作業**
- **既存ファイルの更新の場合は、作業ブランチの内容を反映する形で追記**

### 作成方法
```bash
# handover-docs/YYYY-MM-DD_説明的な名前.md として作成
# 例: handover-docs/2025-06-21_unified_test_runner_implementation.md
```

### 記載内容
- 作業内容の要約
- 解決した問題と未解決の問題
- 技術的な変更点
- 今後の課題
- 注意事項
- 作業の感想とフィードバック（必須）

### 感想セクションに含めるべき内容
- 良かった点
- 課題と提案
- ユーザーへのお願い（改善してほしい点を忌憚なく記載）

### ⚠️ セキュリティ注意事項
**以下の情報は絶対に記載しない：**
- APIキー、トークン、パスワード
- 個人情報（メールアドレス、電話番号など）
- 非公開のURL、エンドポイント
- セキュリティに関わる脆弱性の詳細
- プライベートな設定値やシークレット

これらの情報が必要な場合は、別途セキュアな方法で共有すること。

### 参照方法
過去の引き継ぎ資料は`handover-docs/`ディレクトリに日付順で保存されています。
必要に応じて過去の経緯を確認してください。

## 🔄 継続的改善

このルールは開発の進行に応じて更新されます。重要な変更があった場合は、このファイルも更新してください。